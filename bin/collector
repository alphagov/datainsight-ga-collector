#!/usr/bin/env ruby
# Collects the weekly visits.
# Run: './bin/collector -t TOKEN print'
#
# To obtain authorisation code please visit:
#
# https://accounts.google.com/o/oauth2/auth?response_type=code&scope=https://www.googleapis.com/auth/analytics.readonly&redirect_uri=urn:ietf:wg:oauth:2.0:oob&client_id=1054017153726.apps.googleusercontent.com

require 'bundler/setup'
Bundler.require

require_relative '../lib/date_range'
require_relative '../lib/visits_response'

require_relative '../lib/visits_collector'
require_relative '../lib/config/weekly_visits'

include GLI

program_desc 'Collect the weekly visits'

version 0.1

desc 'Only for the first request you need to pass in the authorisation code'
default_value nil
arg_name 'authorisation code'
flag [:a, :authorisation_code]

desc 'The name of the configuration module to specify the what data to collect from GA and where to put it.'
arg_name 'configuration module'
default_value ""
flag [:c, :config]

pre do |global_options, *ignore|
  authentication_code = global_options[:authorisation_code]
  config = global_options[:config].to_sym
  collector_config = if CollectorConfig.constants.include?(config)
                       CollectorConfig.const_get(config)
                     else
                       raise "Invalid collector configuration or none given. Please choose a configuration from [#{CollectorConfig.constants.join(", ")}]."
                     end

  @visits_collector = Collectors::VisitsCollector.new(authentication_code, collector_config)
end


command :print do |c|
  c.desc 'Print out the collected content'
  c.action do |global_options, options, args|
    puts @visits_collector.collect_as_json
  end
end


command :broadcast do |c|
  c.desc 'Publish the collected content to the queue'
  c.action do |global_options, options, args|
    @visits_collector.broadcast
  end
end


exit run(ARGV)
